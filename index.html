<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendario de Estudio</title>
  <style>
    :root{
      --primary:#2A98A5; /* teal */
      --accent:#FAA84A;  /* orange */
      --bg:#f6f9fb;
      --day-bg:#ffffff;
      --text:#0f1c24;
      --muted:#5f7584;
      --border:#d9e2ec;
      --chip-text:#0b1f2a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
      background: var(--bg); color: var(--text);
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter: saturate(1.2) blur(8px);
      background: linear-gradient(0deg, color-mix(in oklab, white 85%, var(--primary)), #fff);
      border-bottom: 2px solid var(--primary);
      padding: 14px 20px; display:flex; align-items:center; justify-content:space-between;
    }
    header h1{ margin:0; font-size: clamp(18px, 2.2vw, 28px); letter-spacing: .3px; }
    header .meta{ font-size: 14px; color: var(--muted); }
    main{ width: min(1600px, 96vw); margin: 20px auto 56px; padding: 0 4px; }

    .logo { height:60px; width:auto; margin-right:12px; }

    .meta { margin-right: 12px; font-weight:600; }

    .notice{ background: #fff; border:1px solid var(--border); padding:14px 16px; border-left:4px solid var(--accent); border-radius:12px; margin:16px 0; }

    .legend{ display:flex; flex-wrap:wrap; gap:8px; margin:8px 0 20px; align-items:center }
    .legend .item{ display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted) }
    .legend .swatch{ width:14px; height:14px; border-radius:4px; border:1px solid #0001 }

    .month{ margin: 18px 0 32px; border:1px solid var(--border); border-radius:18px; overflow:hidden; background:#fff; box-shadow: 0 12px 28px -18px #0004 }
    .month-header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 14px 16px; background: linear-gradient(180deg, color-mix(in oklab, white 80%, var(--primary)), #fff);
      border-bottom:1px solid var(--border);
    }
    .month-title{ font-size: 1.3rem; font-weight:900; color: var(--primary); letter-spacing:.3px }
    .weekdays, .days{ display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); }
    .weekdays div{ text-align:center; padding:10px 4px; font-size:12px; color:#1d2930; background: color-mix(in oklab, white 90%, var(--primary)); font-weight:700; letter-spacing:.3px; text-transform:uppercase }

    .day{
      background: var(--day-bg);
      border:1px solid var(--border);
      border-radius: 14px;
      padding:10px; display:flex; flex-direction:column; gap:6px; overflow:hidden;
    }
    /* no right-edge border rule needed with gaps */
    .date{ font-size:12px; color: var(--muted); font-weight:800; letter-spacing:.2px }

    .chip{ display:flex; flex-direction:column; align-items:flex-start; gap:4px; padding:8px 10px; border-radius:12px; font-size:12px; line-height:1.2; font-weight:700; border:1px solid #0002; width:100%; }
    .chip .topic{ font-weight:600; font-size:12px; white-space:nowrap; overflow: hidden; text-overflow:ellipsis; text-wrap: wrap;}
    .chip .area{ font-size:9px; opacity:.8; letter-spacing:.2px; }

    /*.today{ outline:none; box-shadow: 0 0 0 2px var(--accent) inset, 0 2px 10px -6px #0003; }*/
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" class="logo"/>
    <h1>Calendario de estudio</h1>
    <div class="meta" id="meta"></div>
  </header>
  <main>
    <div id="messages" class="notice" hidden></div>
    <section id="legend" class="legend"></section>
    <section id="calendars"></section>
  </main>

<script>
(async function(){
  const params = new URLSearchParams(location.search);
  const startParam = params.get('startDate'); // DD-MM-YYYY
  const totalDaysParam = params.get('totalDays');

  const messages = document.getElementById('messages');
  const calendars = document.getElementById('calendars');
  const legend = document.getElementById('legend');
  const meta = document.getElementById('meta');

  const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const WEEKDAYS = ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom']; // Monday-first

  function showMessage(text){ messages.hidden = false; messages.textContent = text; }

  function parseDDMMYYYY(s){
    const m = /^(\d{2})-(\d{2})-(\d{4})$/.exec(s || '');
    if(!m) return null;
    const [_, dd, mm, yyyy] = m;
    const d = new Date(Number(yyyy), Number(mm)-1, Number(dd));
    // validate round-trip
    if(d.getFullYear()!=Number(yyyy) || d.getMonth()!=Number(mm)-1 || d.getDate()!=Number(dd)) return null;
    return d;
  }

  function formatDDMMYYYY(d){
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    return `${dd}-${mm}-${yyyy}`;
  }

  // Ensure params
  const startDate = parseDDMMYYYY(startParam);
  const totalDays = Number(totalDaysParam);

  if(!startDate || !Number.isFinite(totalDays) || totalDays <= 0){
    showMessage('Agrega los parámetros en la URL: ?startDate=DD-MM-YYYY&totalDays=N');
    return;
  }

  if(totalDays < 4){
    showMessage('totalDays debe ser mayor o igual a 4 (los últimos 4 días son de Simulador/Repaso).');
    return;
  }

  meta.textContent = `Inicio: ${formatDDMMYYYY(startDate)} · Días: ${totalDays}`;

  let topics;
  try {
    const res = await fetch('study-topics.json', {cache:'no-store'});
    if(!res.ok) throw new Error('No se pudo cargar study-topics.json');
    topics = await res.json();
  } catch(err){
    showMessage('Error al cargar study-topics.json. Asegúrate de colocarlo junto a este archivo.');
    console.error(err);
    return;
  }

  // Separate last four "Simulador / repaso general" (ensure they are the last four)
  const simuladorLabel = 'Simulador / repaso general';
  const lastFour = topics.slice(-4);
  const allLastAreSim = lastFour.every(t=>t.topic.trim().toLowerCase() === simuladorLabel.toLowerCase());
  if(!allLastAreSim){
    // fallback: pick last four occurrences
    const idxs = topics.map((t,i)=> t.topic.trim().toLowerCase() === simuladorLabel.toLowerCase() ? i : -1).filter(i=>i>=0);
    topics = topics.filter((_,i)=> !idxs.slice(-4).includes(i)).concat(idxs.slice(-4).map(i=> ({...topics[i]})));
  }

  const simDays = topics.slice(-4);
  const otherTopics = topics.slice(0, -4);

  // Distribute otherTopics across (totalDays - 4) days, inserting "Descanso" days if there are
  // more days than topics. Always start with a study topic when possible.
  const studyDays = totalDays - 4;
  const R = otherTopics.length;

  const schedule = [];

  function descansoItem(){
    return { topic: 'Descanso / Simulador / Repaso', 'thematic-area': 'Libre' };
  }

  if (studyDays > 0) {
    if (R >= studyDays) {
      // enough topics: classic even chunking
      const base = Math.floor(R / studyDays);
      const extra = R % studyDays;
      let cursor = 0;
      for (let i = 0; i < studyDays; i++) {
        const count = base + (i < extra ? 1 : 0);
        const chunk = otherTopics.slice(cursor, cursor + count);
        cursor += count;
        schedule.push(chunk);
      }
    } else if (R > 0) {
      // Not enough topics: place one study topic per study day and distribute "Descanso" days
      // evenly across the entire period using cumulative rounding.
      // Always start with a study topic.
      const rests = studyDays - R;
      for (let i = 0; i < R; i++) {
        // Study day
        schedule.push([ otherTopics[i] ]);
        // Evenly spread rests after each study day using cumulative rounding:
        // add = floor((i+1)*rests/R) - floor(i*rests/R)
        const add = Math.floor(((i + 1) * rests) / R) - Math.floor((i * rests) / R);
        for (let r = 0; r < add; r++) {
          schedule.push([ descansoItem() ]);
        }
      }
      // schedule length is guaranteed to be studyDays (R study + rests)
    } else {
      // No other topics (only simulator ones exist) -> fill with rest days, warn the user.
      for (let i = 0; i < studyDays; i++) schedule.push([ descansoItem() ]);
      showMessage('No hay temas (excluyendo Simulador) para los días previos. Se agregaron días de Descanso.');
    }
  }
  // Append the four single-topic days at the very end
  for (const s of simDays) { schedule.push([s]); }
  for (const s of simDays) { schedule.push([s]); }

  // Build date range
  const days = [];
  for(let i=0;i<totalDays;i++){
    const d = new Date(startDate); d.setDate(d.getDate()+i);
    days.push({ date: d, items: schedule[i] || [] });
  }

  // Map thematic-area => color (distinct + accessible)
  const uniqueAreas = Array.from(new Set([...topics.map(t=>t['thematic-area']), 'Libre']));
  // Pallete with good contrast and distinct material colors
  const palette = [
    '#EF476F', '#FFD166', '#06D6A0', '#118AB2', '#073B4C',
    '#8E44AD', '#E67E22', '#2ECC71', '#3498DB', '#E74C3C',
    '#1ABC9C', '#9B59B6', '#F39C12', '#27AE60', '#2980B9',
    '#C0392B', '#16A085', '#7F8C8D', '#D35400', '#2C3E50'
  ];
  const areaColor = new Map();
  uniqueAreas.forEach((area, idx)=>{
    const color = palette[idx % palette.length];
    areaColor.set(area, color);
  });

  // Render legend
  /*
  for(const area of uniqueAreas){
    const item = document.createElement('div'); item.className = 'item';
    const sw = document.createElement('span'); sw.className = 'swatch'; sw.style.background = areaColor.get(area);
    const label = document.createElement('span'); label.textContent = area;
    item.append(sw, label); legend.appendChild(item);
  }
  */

  // Group days by month
  const byMonth = new Map();
  for (const entry of days) {
    const key = `${entry.date.getFullYear()}-${String(entry.date.getMonth()+1).padStart(2,'0')}`;
    if (!byMonth.has(key)) byMonth.set(key, []);
    byMonth.get(key).push(entry);
  }

  // Utility: first weekday offset (Mon=0..Sun=6)
  function weekdayMon0(date){
    let w = date.getDay(); // 0=Sun..6=Sat
    return (w+6)%7; // 0=Mon..6=Sun
  }

  // Render each month as a calendar table
  const todayStr = formatDDMMYYYY(new Date());

  const months = Array.from(byMonth.entries()).sort((a,b)=>{
    const [ay, am] = a[0].split('-').map(Number);
    const [by, bm] = b[0].split('-').map(Number);
    return ay === by ? am - bm : ay - by;
  });
  for (const [key, entries] of months) {
    const monthDate = new Date(entries[0].date.getFullYear(), entries[0].date.getMonth(), 1);
    const year = monthDate.getFullYear();
    const month = monthDate.getMonth();

    const monthWrap = document.createElement('section'); monthWrap.className='month';

    const header = document.createElement('div'); header.className = 'month-header';
    const title = document.createElement('div'); title.className = 'month-title';
    title.textContent = `${MONTHS[month]} ${year}`;
    header.appendChild(title);
    monthWrap.appendChild(header);

    const weekdaysRow = document.createElement('div'); weekdaysRow.className='weekdays';
    WEEKDAYS.forEach(w=>{ const el = document.createElement('div'); el.textContent = w; weekdaysRow.appendChild(el); });
    monthWrap.appendChild(weekdaysRow);

    const grid = document.createElement('div'); grid.className='days';
    grid.style.gap = '8px';
    grid.style.padding = '8px';

    // calculate leading empty cells (from first day of month to Monday)
    const firstOfMonth = new Date(year, month, 1);
    const lead = weekdayMon0(firstOfMonth);
    for(let i=0;i<lead;i++){ const blank = document.createElement('div'); blank.className='day blank'; grid.appendChild(blank); }

    // fill days of month
    const daysInMonth = new Date(year, month+1, 0).getDate();

    for(let day=1; day<=daysInMonth; day++){
      const cell = document.createElement('div'); cell.className='day';
      const thisDate = new Date(year, month, day);
      const dateBar = document.createElement('div'); dateBar.className='date'; dateBar.textContent = String(day);
      const labels = document.createElement('div'); labels.className = 'labels'; labels.style.display='flex'; labels.style.flexDirection='column'; labels.style.gap='6px'; labels.style.overflow='auto'; labels.style.flex='1';

      const thisStr = formatDDMMYYYY(thisDate);
      const inStudy = entries.find(e=> formatDDMMYYYY(e.date) === thisStr);
      if(inStudy){
        for(const item of inStudy.items){
          const chip = document.createElement('div'); chip.className='chip';
          const bg = areaColor.get(item['thematic-area']);
          chip.style.background = bg;
          chip.style.color = bestTextColor(bg);
          chip.style.borderColor = '#0002';

          const topic = document.createElement('div'); topic.className='topic'; topic.textContent = item.topic;
          //const area = document.createElement('div'); area.className='area'; area.textContent = item['thematic-area'];
          //chip.append(topic, area);
          chip.append(topic);
          labels.appendChild(chip);
        }
      }

      const thisStr2 = formatDDMMYYYY(thisDate);
      if(thisStr2 === todayStr){ cell.classList.add('today'); }

      cell.append(dateBar, labels);
      grid.appendChild(cell);
    }

    monthWrap.appendChild(grid);
    calendars.appendChild(monthWrap);
  }

  function shortArea(area){
    // keep it short but readable in chips
    const map = {
      'Infectología II + Urgencias': 'Inf II + Urg',
      'Gastroenterología II + Misceláneos': 'Gastro II + Misc',
      'Neuro, Geriatría y Farmacología': 'Neuro/Ger/Farm',
      'Salud Pública + Epidemiología': 'SP + Epi',
      'Misceláneos + Reforzamiento': 'Misc + Ref'
    };
    return map[area] || area;
  }

  function bestTextColor(hex){
    // contrast check (YIQ)
    const {r,g,b} = hexToRgb(hex);
    const yiq = (r*299 + g*587 + b*114)/1000;
    return yiq >= 140 ? '#0b1f2a' : '#ffffff';
  }
  function hexToRgb(hex){
    const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return m ? { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) } : {r:0,g:0,b:0};
  }
})();
</script>
</body>
</html>
